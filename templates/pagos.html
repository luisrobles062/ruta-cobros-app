<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Pagos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
</head>
<body>
  {% include "_navbar.html" %}
  <div class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="header">
      <h1 class="h1">Pagos</h1>
      <div class="actions">
        <span class="badge">Hoy: {{ total_hoy_pagos }}</span>
        <span class="badge">Histórico: {{ total_recaudado }}</span>
        <a class="btn" href="{{ url_for('pagos_diario') }}">Recaudo por día</a>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <form method="get" action="{{ url_for('pagos_listado') }}" class="form">
          <div class="field">
            <label>Filtrar por cliente</label>
            <select name="cliente_id">
              <option value="">-- Todos --</option>
              {% for c in clientes %}
                <option value="{{ c[0] }}" {% if cliente_id_filtro == c[0] %}selected{% endif %}>{{ c[1] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">Aplicar filtro</button>
            {% if cliente_id_filtro %}
              <a class="btn" href="{{ url_for('pagos_listado') }}">Quitar filtro</a>
            {% endif %}
          </div>
        </form>
      </div>

      {% if resumen %}
      <div class="card">
        <div class="header" style="margin:0 0 8px 0">
          <h2 class="h1" style="font-size:18px">Resumen de {{ resumen.nombre }}</h2>
        </div>
        <div class="grid cols-2">
          <div class="kpi"><div class="label">Monto prestado</div><div class="value">{{ money(resumen.monto_prestado) }}</div></div>
          <div class="kpi"><div class="label">Deuda actual</div><div class="value">{{ money(resumen.deuda_actual) }}</div></div>
          <div class="kpi"><div class="label">Total pagado</div><div class="value">{{ money(resumen.total_pagado) }}</div></div>
          <div class="kpi"><div class="label">Último pago</div><div class="value">{{ resumen.fecha_ultimo_pago or '—' }}</div></div>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="card" style="margin-top:14px">
      <h2 class="h1" style="font-size:18px;margin:0 0 8px 0">Registrar pago</h2>
      <form method="post" action="{{ url_for('pago_nuevo') }}" class="form">
        <div class="fields">
          <div class="field">
            <label>Cliente</label>
            <select name="cliente_id" required>
              <option value="">Seleccione…</option>
              {% for c in clientes %}
                <option value="{{ c[0] }}" {% if cliente_id_filtro == c[0] %}selected{% endif %}>{{ c[1] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label>Monto</label>
            <input name="monto" placeholder="Ej: 25.000" required>
          </div>
          <div class="field">
            <label>Fecha</label>
            <input type="date" name="fecha_pago">
          </div>
          <div class="field">
            <label>Método</label>
            <input name="metodo" placeholder="Efectivo, Nequi, etc.">
          </div>
          <div class="field" style="flex:2 1 320px">
            <label>Nota</label>
            <input name="nota" placeholder="Observaciones (opcional)">
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">Guardar pago</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:14px">
      <h2 class="h1" style="font-size:18px;margin:0 0 8px 0">Listado de pagos{% if cliente_id_filtro %} (cliente filtrado){% endif %}</h2>
      {% if pagos and pagos|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Monto</th>
              <th>Método</th>
              <th>Nota</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pagos %}
              <tr>
                <td>{{ p[0] }}</td>
                <td>{{ p[2] }}</td>
                <td><a href="{{ url_for('pagos_listado', cliente_id=p[5]) }}">{{ p[6] }}</a></td>
                <td>{{ money(p[1]) }}</td>
                <td>{{ p[3] or '—' }}</td>
                <td>{{ p[4] or '—' }}</td>
                <td class="right">
                  <div class="actions" style="justify-content:flex-end">
                    <a class="btn small" href="{{ url_for('pago_editar', pago_id=p[0]) }}">Editar</a>
                    <form method="post" action="{{ url_for('pago_eliminar', pago_id=p[0]) }}" onsubmit="return confirm('¿Eliminar este pago?')">
                      <button class="btn small danger" type="submit">Eliminar</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted">No hay pagos para mostrar.</p>
      {% endif %}
    </div>

  </div>
</body>
</html>
