<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Listado de Clientes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input[type="text"], input[type="number"] {
            padding: 5px;
            width: 200px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
        .mora {
            background-color: #ffe5e5;
        }
        .pagar-btn {
            padding: 4px 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .pagar-btn:hover {
            background-color: #45a049;
        }
        .alerta {
            color: red;
            font-weight: bold;
        }
    </style>
    <script>
        function filtrarClientes() {
            const filtro = document.getElementById('filtroNombre').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaClientes tbody tr');
            filas.forEach(fila => {
                const nombre = fila.querySelector('.nombre').textContent.toLowerCase();
                fila.style.display = nombre.includes(filtro) ? '' : 'none';
            });
        }
    </script>
</head>
<body>
    <h1>Listado de Clientes</h1>

    <label for="filtroNombre">Filtrar por nombre:</label>
    <input type="text" id="filtroNombre" onkeyup="filtrarClientes()" placeholder="Buscar cliente...">

    <a href="/nuevo" style="margin-left: 20px;">➕ Agregar nuevo cliente</a>

    {% if clientes %}
        <table id="tablaClientes">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Monto Prestado</th>
                    <th>Deuda Actual</th>
                    <th>Último Pago</th>
                    <th>Registrar Pago</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes %}
                    {% set ultima_fecha = cliente['ultima_fecha_pago'] %}
                    {% set hoy = fecha_actual %}
                    {% set dias_mora = (hoy - ultima_fecha).days if ultima_fecha else None %}
                    <tr {% if dias_mora is not none and dias_mora >= 1 %}class="mora"{% endif %}>
                        <td>{{ cliente['fecha'] }}</td>
                        <td class="nombre">{{ cliente['nombre'] }}</td>
                        <td>${{ "{:,.0f}".format(cliente['monto_prestado']) }}</td>
                        <td>${{ "{:,.0f}".format(cliente['deuda_actual']) }}</td>
                        <td>
                            {% if ultima_fecha %}
                                {{ ultima_fecha.strftime("%d/%m/%Y") }}
                                {% if dias_mora >= 1 %}
                                    <div class="alerta">En mora hace {{ dias_mora }} día(s)</div>
                                {% endif %}
                            {% else %}
                                Sin pagos
                            {% endif %}
                        </td>
                        <td>
                            <form action="/pago" method="POST">
                                <input type="hidden" name="cliente_id" value="{{ cliente['id'] }}">
                                <input type="number" name="monto_pago" min="0" required>
                                <button type="submit" class="pagar-btn">Pagar</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hay clientes registrados.</p>
    {% endif %}

    <br><br>
    <a href="/logout">Cerrar sesión</a>
</body>
</html>
