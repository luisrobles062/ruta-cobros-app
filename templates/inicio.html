<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Clientes morosos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
</head>
<body>
  {% include "_navbar.html" %}
  <div class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="header">
      <h1 class="h1">Clientes morosos</h1>
      <div class="actions">
        <a class="btn" href="{{ url_for('cliente_nuevo') }}">+ Nuevo cliente</a>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Clientes morosos</div>
        <div class="value">{{ total_clientes }}</div>
      </div>
      <div class="kpi">
        <div class="label">Recaudado histórico</div>
        <div class="value">{{ total_recaudado }}</div>
      </div>
      <div class="kpi">
        <div class="label">Deuda total</div>
        <div class="value">{{ money(deuda_total) }}</div>
      </div>
      <div class="kpi">
        <div class="label">Efectivo hoy (caja)</div>
        <div class="value">{{ money(efectivo_hoy) }}</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      {% if clientes and clientes|length>0 %}
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Monto prestado</th>
              <th>Deuda actual</th>
              <th>Fecha préstamo</th>
              <th>Último pago</th>
              <th>Observaciones</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for c in clientes %}
            <tr>
              <td>{{ c[0] }}</td>
              <td>{{ c[1] }}</td>
              <td>{{ money(c[2]) }}</td>
              <td>{{ money(c[3]) }}</td>
              <td>{{ c[5] }}</td>
              <td>{{ c[6] or '—' }}</td>
              <td>{{ c[4] or '—' }}</td>
              <td class="right">
                <div class="actions" style="justify-content:flex-end">
                  <a class="btn small" href="{{ url_for('cliente_editar', cliente_id=c[0]) }}">Editar</a>
                  <form method="post" action="{{ url_for('cliente_eliminar', cliente_id=c[0]) }}" onsubmit="return confirm('¿Eliminar este cliente? Se eliminarán también sus pagos.')">
                    <button class="btn small danger" type="submit">Eliminar</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted">No hay clientes con deuda. Revisa <a href="{{ url_for('clientes_archivados') }}">Clientes pagados</a>.</p>
      {% endif %}
    </div>
  </div>
</body>
</html>
